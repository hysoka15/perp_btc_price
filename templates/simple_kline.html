<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简化K线图 - 多交易所BTC价差分析</title>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background: #0b0e11;
            color: #ffffff;
        }
        
        .header {
            background: #1a1d21;
            padding: 15px 20px;
            border-bottom: 1px solid #2a2d31;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .control-group label {
            font-size: 14px;
            color: #ccc;
        }
        
        .btn {
            padding: 8px 16px;
            background: #2a2d31;
            border: 1px solid #404040;
            border-radius: 4px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }
        
        .btn:hover {
            background: #3a3d41;
        }
        
        .btn.active {
            background: #0088cc;
            border-color: #0088cc;
        }
        
        .exchange-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #2a2d31;
            border: 1px solid #404040;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            margin-right: 8px;
            margin-bottom: 4px;
        }
        
        .exchange-checkbox:hover {
            background: #3a3d41;
        }
        
        .exchange-checkbox.active {
            background: #0088cc;
            border-color: #0088cc;
        }
        
        .exchange-checkbox input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: #ffffff;
        }
        
        .exchanges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .main-content {
            display: flex;
            height: calc(100vh - 80px);
        }
        
        .chart-container {
            flex: 1;
            background: #0b0e11;
            position: relative;
            min-height: 600px;
        }
        
        .sidebar {
            width: 300px;
            background: #1a1d21;
            border-left: 1px solid #2a2d31;
            padding: 20px;
            overflow-y: auto;
        }
        
        .info-section {
            margin-bottom: 20px;
        }
        
        .info-section h3 {
            color: #0088cc;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #2a2d31;
        }
        
        .positive {
            color: #26a69a;
        }
        
        .negative {
            color: #ef5350;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #2a2d31;
            border-top: 3px solid #0088cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #chart {
            width: 100%;
            height: 100%;
        }
        
        .demo-notice {
            background: #ffc107;
            color: #000;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="demo-notice">
        🎉 专业K线图演示版本 - 支持交易所切换、时间周期选择、缩放滚动等功能
    </div>
    
    <div class="header">
        <div class="title">专业K线图 - BTC价差分析</div>
        
        <div class="controls">
            <div class="control-group">
                <label>交易所:</label>
                <div class="exchanges-container">
                    <label class="exchange-checkbox active" data-exchange="aster">
                        <input type="checkbox" checked data-exchange="aster"> Aster
                    </label>
                    <label class="exchange-checkbox" data-exchange="lighter">
                        <input type="checkbox" data-exchange="lighter"> Lighter
                    </label>
                    <label class="exchange-checkbox" data-exchange="edgex">
                        <input type="checkbox" data-exchange="edgex"> EdgeX
                    </label>
                </div>
            </div>
            
            <div class="control-group">
                <label>周期:</label>
                <button class="btn" data-interval="1m">1分</button>
                <button class="btn" data-interval="5m">5分</button>
                <button class="btn" data-interval="15m">15分</button>
                <button class="btn active" data-interval="1h">1时</button>
                <button class="btn" data-interval="4h">4时</button>
                <button class="btn" data-interval="1d">1日</button>
            </div>
            
            <div class="status">
                <div class="status-indicator"></div>
                <span id="lastUpdate">加载中...</span>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="chart-container">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>加载K线数据...</div>
            </div>
            <canvas id="chart"></canvas>
        </div>
        
        <div class="sidebar">
            <div class="info-section">
                <h3>📊 当前数据</h3>
                <div id="currentData">
                    <div class="info-item">
                        <span>交易所:</span>
                        <span id="currentExchange">Aster</span>
                    </div>
                    <div class="info-item">
                        <span>周期:</span>
                        <span id="currentInterval">1小时</span>
                    </div>
                    <div class="info-item">
                        <span>数据量:</span>
                        <span id="dataCount">-</span>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <h3>💹 最新价差</h3>
                <div id="latestPriceInfo">
                    <div class="info-item">
                        <span>开盘:</span>
                        <span id="openPrice" class="positive">--</span>
                    </div>
                    <div class="info-item">
                        <span>最高:</span>
                        <span id="highPrice" class="positive">--</span>
                    </div>
                    <div class="info-item">
                        <span>最低:</span>
                        <span id="lowPrice" class="negative">--</span>
                    </div>
                    <div class="info-item">
                        <span>收盘:</span>
                        <span id="closePrice" class="positive">--</span>
                    </div>
                    <div class="info-item">
                        <span>成交量:</span>
                        <span id="volume">--</span>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <h3>⚡ 功能特性</h3>
                <div style="font-size: 12px; line-height: 1.6; color: #ccc;">
                    <p>✅ 专业K线图显示</p>
                    <p>✅ 多交易所数据切换</p>
                    <p>✅ 多时间周期支持</p>
                    <p>✅ 鼠标滚轮缩放</p>
                    <p>✅ 拖拽浏览历史</p>
                    <p>✅ 实时数据更新</p>
                    <p>✅ 十字线价格查看</p>
                </div>
            </div>
            
            <div class="info-section">
                <h3>📈 统计信息</h3>
                <div id="statisticsInfo">
                    <div class="info-item">
                        <span>总记录:</span>
                        <span id="totalRecords">-</span>
                    </div>
                    <div class="info-item">
                        <span>活跃交易所:</span>
                        <span id="activeExchanges">-</span>
                    </div>
                    <div class="info-item">
                        <span>最新时间:</span>
                        <span id="latestTime">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 使用轻量级图表库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    
    <script>
        class SimpleKLineManager {
            constructor() {
                this.chart = null;
                this.selectedExchanges = ['aster'];  // 改为数组支持多选
                this.currentInterval = '1h';
                this.refreshInterval = null;
                this.isLoading = false;
                this.isLoadingMore = false;
                this.isLoadingMoreHistory = false;
                this.visibleDataCount = this.getDefaultVisibleCount(this.currentInterval);
                this.viewStartIndex = 0;
                this.fullDataLength = 0;
                this.previousFullDataLength = 0;
                this.isViewInitialized = false;
                this.dragAccumulator = 0;
                
                this.init();
            }
            
            init() {
                this.createChart();
                this.bindEvents();
                this.loadData();
                this.loadStatistics();
                this.startAutoRefresh();
            }

            getDefaultVisibleCount(interval) {
                // 优化默认显示数量，确保合适的线条密度
                const defaults = {
                    '1m': 120,   // 2小时数据，密度适中
                    '5m': 144,   // 12小时数据
                    '15m': 96,   // 24小时数据
                    '1h': 168,   // 7天数据
                    '4h': 84,    // 14天数据，密度更合理
                    '1d': 60     // 2个月数据
                };
                return defaults[interval] || 100;
            }
            
            createChart() {
                const ctx = document.getElementById('chart').getContext('2d');
                
                // 检查缩放插件是否可用
                if (typeof window.ChartZoom !== 'undefined') {
                    Chart.register(window.ChartZoom);
                    console.log('✅ 缩放插件已注册');
                } else {
                    console.log('ℹ️ 未检测到zoom插件，使用自定义拖拽逻辑');
                }
                
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        backgroundColor: '#0b0e11',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(26, 29, 33, 0.95)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#2a2d31',
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    title: function(context) {
                                        return '时间: ' + context[0].label;
                                    },
                                    label: function(context) {
                                        const dataset = context.dataset;
                                        const dataIndex = context.dataIndex;
                                        const value = context.parsed.y;
                                        
                                        if (value === null || value === undefined) {
                                            return `${dataset.label}: 无数据`;
                                        }
                                        
                                        const sign = value >= 0 ? '+' : '';
                                        let result = [`${dataset.label}: ${sign}${value.toFixed(4)} USDT`];
                                        
                                        // 如果有详细价格信息，显示币安价格和交易所价格
                                        if (dataset.exchangePrices && dataset.binancePrices && 
                                            dataset.exchangePrices[dataIndex] !== null && dataset.exchangePrices[dataIndex] !== undefined &&
                                            dataset.binancePrices[dataIndex] !== null && dataset.binancePrices[dataIndex] !== undefined) {
                                            const exchangePrice = parseFloat(dataset.exchangePrices[dataIndex]);
                                            const binancePrice = parseFloat(dataset.binancePrices[dataIndex]);
                                            
                                            if (!Number.isNaN(binancePrice)) {
                                                result.push(`币安价格: ${binancePrice.toFixed(2)} USDT`);
                                            }
                                            if (!Number.isNaN(exchangePrice)) {
                                                result.push(`${dataset.exchange.toUpperCase()}价格: ${exchangePrice.toFixed(2)} USDT`);
                                            }
                                        }
                                        
                                        return result;
                                    }
                                }
                            },
                            zoom: {
                                pan: {
                                    enabled: false,  // 禁用拖拽
                                    mode: 'x'
                                },
                                zoom: {
                                    wheel: {
                                        enabled: false  // 禁用滚轮缩放
                                    },
                                    mode: 'x'
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: '#2a2d31'
                                },
                                ticks: {
                                    color: '#ffffff',
                                    maxTicksLimit: 10
                                }
                            },
                            y: {
                                grid: {
                                    color: function(context) {
                                        return context.tick.value === 0 ? '#ffffff' : '#2a2d31';
                                    }
                                },
                                ticks: {
                                    color: '#ffffff',
                                    callback: function(value) {
                                        const sign = value >= 0 ? '+' : '';
                                        return sign + value.toFixed(2);
                                    }
                                }
                            }
                        },
                        elements: {
                            line: {
                                tension: 0.1,
                                borderWidth: 2
                            },
                            point: {
                                radius: 0,
                                hoverRadius: 4
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                });
                
                // 启用缩放和平移
                this.enableChartInteraction();
            }
            
            enableChartInteraction() {
                const canvas = this.chart.canvas;
                let isDragging = false;
                let lastX = 0;
                this.dragAccumulator = 0;

                const getFullLength = () => this.chart.data.fullLabels ? this.chart.data.fullLabels.length : 0;

                canvas.addEventListener('mousedown', (e) => {
                    if (!getFullLength()) return;
                    isDragging = true;
                    lastX = e.clientX;
                    this.dragAccumulator = 0;
                    canvas.style.cursor = 'grabbing';
                    e.preventDefault();
                });

                canvas.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const fullLength = getFullLength();
                    if (!fullLength) {
                        lastX = e.clientX;
                        return;
                    }

                    const rect = canvas.getBoundingClientRect();
                    const pixelsPerPoint = rect.width > 0 ? rect.width / Math.max(1, this.visibleDataCount) : 10;

                    const deltaX = e.clientX - lastX;
                    this.dragAccumulator += deltaX / pixelsPerPoint;
                    const moveAmount = Math.trunc(this.dragAccumulator);

                    if (moveAmount !== 0) {
                        this.dragAccumulator -= moveAmount;

                        let newViewStart = this.viewStartIndex - moveAmount;
                        const maxStart = Math.max(0, fullLength - this.visibleDataCount);

                        if (newViewStart < 0) {
                            if (!this.isLoadingMoreHistory) {
                                console.log('🔄 到达左边界，尝试加载更多历史数据...');
                                this.loadMoreHistoricalData();
                            }
                            newViewStart = 0;
                        }

                        if (newViewStart > maxStart) {
                            newViewStart = maxStart;
                        }

                        if (newViewStart !== this.viewStartIndex) {
                            this.viewStartIndex = newViewStart;
                            // 直接更新视图，不要让updateVisibleRange覆盖viewStartIndex
                            this.updateVisibleRange(this.viewStartIndex, -1);
                            console.log(`📊 视图窗口: ${this.viewStartIndex} - ${this.viewStartIndex + this.visibleDataCount - 1} (固定${this.visibleDataCount}条)`);
                        }
                    }

                    lastX = e.clientX;
                    e.preventDefault();
                });

                const stopDragging = () => {
                    if (isDragging) {
                        isDragging = false;
                        canvas.style.cursor = 'default';
                    }
                };

                canvas.addEventListener('mouseup', stopDragging);
                canvas.addEventListener('mouseleave', stopDragging);
                window.addEventListener('mouseup', stopDragging);

                canvas.addEventListener('wheel', (e) => this.handleWheelZoom(e), { passive: false });

                const resetZoomBtn = document.createElement('button');
                resetZoomBtn.textContent = '重置视图';
                resetZoomBtn.className = 'btn';
                resetZoomBtn.style.position = 'absolute';
                resetZoomBtn.style.top = '10px';
                resetZoomBtn.style.right = '10px';
                resetZoomBtn.style.zIndex = '1000';

                resetZoomBtn.addEventListener('click', () => {
                    this.resetViewToLatest();
                });

                const chartContainer = document.querySelector('.chart-container');
                chartContainer.appendChild(resetZoomBtn);

                console.log('✅ 自定义拖拽和缩放功能已启用:');
                console.log('  - 鼠标拖拽: 左右平移时间轴');
                console.log('  - 鼠标滚轮: 缩放时间范围');
                console.log('  - 重置按钮: 返回最新数据');
            }

            handleWheelZoom(event) {
                event.preventDefault();

                const fullLength = this.chart.data.fullLabels ? this.chart.data.fullLabels.length : 0;
                if (!fullLength) return;

                if (event.deltaY === 0) return;

                const direction = event.deltaY < 0 ? 'in' : 'out';
                const zoomStep = Math.max(5, Math.round(this.visibleDataCount * 0.1));
                const focusRatio = this.computeFocusRatio(event);

                if (direction === 'in' && this.visibleDataCount > 10) {
                    const newCount = Math.max(10, this.visibleDataCount - zoomStep);
                    this.adjustVisibleRange(newCount, focusRatio);
                    console.log(`🔍 放大视图 -> 显示 ${this.visibleDataCount} 条数据`);
                } else if (direction === 'out' && this.visibleDataCount < fullLength) {
                    const newCount = Math.min(fullLength, this.visibleDataCount + zoomStep);
                    this.adjustVisibleRange(newCount, focusRatio);
                    console.log(`🔎 缩小视图 -> 显示 ${this.visibleDataCount} 条数据`);
                }
            }

            computeFocusRatio(event) {
                const canvas = this.chart.canvas;
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                if (!Number.isFinite(x) || rect.width <= 0) {
                    return 0.5;
                }
                const ratio = x / rect.width;
                return Math.min(0.95, Math.max(0.05, ratio));
            }

            adjustVisibleRange(newCount, focusRatio = 0.5) {
                const fullLength = this.chart.data.fullLabels ? this.chart.data.fullLabels.length : 0;
                if (!fullLength) return;

                const currentRange = this.visibleDataCount - 1;
                const centerIndex = this.viewStartIndex + (currentRange > 0 ? currentRange * focusRatio : 0);

                this.visibleDataCount = Math.min(Math.max(newCount, 10), fullLength);
                const maxStart = Math.max(0, fullLength - this.visibleDataCount);

                let newViewStart = Math.round(centerIndex - (this.visibleDataCount - 1) * focusRatio);
                newViewStart = Math.max(0, Math.min(maxStart, newViewStart));

                this.viewStartIndex = newViewStart;
                this.updateVisibleRange(this.viewStartIndex, -1);
            }

            resetViewToLatest() {
                const fullLength = this.chart.data.fullLabels ? this.chart.data.fullLabels.length : 0;
                if (!fullLength) return;

                this.visibleDataCount = Math.min(this.getDefaultVisibleCount(this.currentInterval), fullLength);
                const maxStart = Math.max(0, fullLength - this.visibleDataCount);
                this.viewStartIndex = maxStart;
                this.updateVisibleRange(this.viewStartIndex, -1);
                console.log(`🔄 视图重置 -> 最新 ${this.visibleDataCount} 条数据`);
            }

            isNearRightEdge() {
                const fullLength = this.chart.data.fullLabels ? this.chart.data.fullLabels.length : 0;
                if (!fullLength) return true;
                const maxStart = Math.max(0, fullLength - this.visibleDataCount);
                return this.viewStartIndex >= Math.max(0, maxStart - 2);
            }

            updateVisibleRange(startIndex, endIndex) {
                const fullLabels = this.chart.data.fullLabels;
                const allDatasets = this.chart.data.datasets;

                if (!fullLabels || fullLabels.length === 0) return;

                // 确保索引范围安全且保持固定视窗大小
                const safeStart = Math.max(0, Math.min(startIndex, fullLabels.length - 1));
                
                // 关键修复：保持固定的visibleDataCount，不让endIndex影响窗口大小
                const actualVisibleCount = Math.min(this.visibleDataCount, fullLabels.length - safeStart);
                const safeEnd = safeStart + actualVisibleCount - 1;

                this.chart.data.labels = fullLabels.slice(safeStart, safeEnd + 1);
                this.dragAccumulator = 0;
                
                // 更新每个数据集的可见部分
                this.chart.data.datasets.forEach((dataset) => {
                    if (dataset && dataset.fullData) {
                        dataset.data = dataset.fullData.slice(safeStart, safeEnd + 1);
                    }
                    if (dataset && dataset.fullExchangePrices) {
                        dataset.exchangePrices = dataset.fullExchangePrices.slice(safeStart, safeEnd + 1);
                    }
                    if (dataset && dataset.fullBinancePrices) {
                        dataset.binancePrices = dataset.fullBinancePrices.slice(safeStart, safeEnd + 1);
                    }
                    if (dataset && dataset.fullPriceDiffs) {
                        dataset.priceDiffs = dataset.fullPriceDiffs.slice(safeStart, safeEnd + 1);
                    }
                });

                // 根据实际显示的数据点数调整X轴刻度
                if (this.chart.options?.scales?.x?.ticks) {
                    this.chart.options.scales.x.ticks.maxTicksLimit = Math.max(3, Math.min(12, Math.ceil(actualVisibleCount / 10)));
                }

                this.chart.update('none');
                
                console.log(`🎯 视窗更新: ${safeStart} - ${safeEnd} (固定显示${actualVisibleCount}条数据)`);
            }
            
            bindEvents() {
                // 交易所多选切换
                document.querySelectorAll('.exchange-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input[type="checkbox"]');
                    
                    label.addEventListener('click', (e) => {
                        if (this.isLoading) return;
                        e.preventDefault();
                        
                        // 切换复选框状态
                        checkbox.checked = !checkbox.checked;
                        
                        // 更新视觉样式
                        if (checkbox.checked) {
                            label.classList.add('active');
                        } else {
                            label.classList.remove('active');
                        }
                        
                        // 更新选中的交易所列表
                        this.updateSelectedExchanges();
                        
                        this.isViewInitialized = false;
                        this.visibleDataCount = this.getDefaultVisibleCount(this.currentInterval);
                        this.viewStartIndex = 0;
                        
                        // 重新加载数据
                        this.loadData();
                    });
                    
                    // 直接点击复选框时也要处理
                    checkbox.addEventListener('change', (e) => {
                        if (this.isLoading) return;
                        
                        // 更新视觉样式
                        if (checkbox.checked) {
                            label.classList.add('active');
                        } else {
                            label.classList.remove('active');
                        }
                        
                        // 更新选中的交易所列表
                        this.updateSelectedExchanges();
                        
                        this.isViewInitialized = false;
                        this.visibleDataCount = this.getDefaultVisibleCount(this.currentInterval);
                        this.viewStartIndex = 0;
                        
                        // 重新加载数据
                        this.loadData();
                    });
                });
                
                // 时间周期切换
                document.querySelectorAll('[data-interval]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (this.isLoading) return;
                        
                        document.querySelectorAll('[data-interval]').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        this.currentInterval = e.target.dataset.interval;
                        this.visibleDataCount = this.getDefaultVisibleCount(this.currentInterval);
                        this.isViewInitialized = false;
                        this.viewStartIndex = 0;
                        this.loadData();
                        
                        // 更新显示
                        document.getElementById('currentInterval').textContent = 
                            e.target.textContent;
                    });
                });
            }
            
            updateSelectedExchanges() {
                // 收集所有选中的交易所
                const selectedExchanges = [];
                document.querySelectorAll('.exchange-checkbox input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedExchanges.push(checkbox.dataset.exchange);
                });
                
                // 确保至少有一个交易所被选中
                if (selectedExchanges.length === 0) {
                    // 如果没有选中任何交易所，默认选中aster
                    const asterCheckbox = document.querySelector('.exchange-checkbox input[data-exchange="aster"]');
                    if (asterCheckbox) {
                        asterCheckbox.checked = true;
                        asterCheckbox.closest('.exchange-checkbox').classList.add('active');
                        selectedExchanges.push('aster');
                    }
                }
                
                this.selectedExchanges = selectedExchanges;
                
                // 更新侧边栏显示
                document.getElementById('currentExchange').textContent = 
                    this.selectedExchanges.map(ex => ex.toUpperCase()).join(', ');
                
                console.log('选中的交易所:', this.selectedExchanges);
            }
            
            async loadData(additionalLimit = 200, isLoadingMore = false) {
                if (this.isLoading) {
                    if (isLoadingMore) {
                        console.log('⏳ 历史数据仍在加载，忽略重复请求');
                    }
                    return;
                }

                const previousLength = this.chart?.data?.fullLabels ? this.chart.data.fullLabels.length : 0;
                const wasAtRightEdge = this.isViewInitialized ? this.isNearRightEdge() : true;

                this.isLoading = true;
                this.isLoadingMore = isLoadingMore;

                if (!isLoadingMore) {
                    this.showLoading(true);
                } else {
                    document.getElementById('lastUpdate').textContent = '加载历史数据...';
                }

                try {
                    const exchangesParam = this.selectedExchanges.join(',');
                    const limit = isLoadingMore ? additionalLimit * 5 : additionalLimit;

                    const response = await fetch(
                        `/api/kline_data?exchanges=${exchangesParam}&interval=${this.currentInterval}&limit=${limit}`
                    );
                    const result = await response.json();

                    if (result.success && result.data) {
                        this.updateMultiChart(result.data, {
                            isLoadingMore,
                            wasAtRightEdge,
                            previousLength
                        });
                        this.updateMultiSidebar(result.data);

                        if (!isLoadingMore) {
                            document.getElementById('lastUpdate').textContent =
                                '更新: ' + new Date().toLocaleTimeString();
                        }

                        let totalCount = 0;
                        Object.values(result.data).forEach(exchangeData => {
                            totalCount += exchangeData.length;
                        });
                        document.getElementById('dataCount').textContent = `${totalCount} 条`;

                        if (isLoadingMore) {
                            console.log(`📈 加载了更多历史数据，总数据点: ${this.chart.data.fullLabels ? this.chart.data.fullLabels.length : totalCount}`);
                        } else {
                            console.log(`✅ 数据刷新完成: ${this.selectedExchanges.join(', ')} (${this.currentInterval})`);
                        }

                        return result.data;
                    } else {
                        throw new Error(result.error || '数据加载失败');
                    }

                } catch (error) {
                    console.error('❌ 加载数据失败:', error);
                    if (!isLoadingMore) {
                        document.getElementById('lastUpdate').textContent = '加载失败';
                    }
                    return null;
                } finally {
                    this.isLoading = false;
                    this.isLoadingMore = false;
                    if (!isLoadingMore) {
                        this.showLoading(false);
                    }
                }
            }
            
            async loadMoreHistoricalData() {
                if (this.isLoadingMoreHistory || this.isLoading) {
                    return false;
                }

                this.isLoadingMoreHistory = true;
                console.log('📊 尝试加载更多历史数据...');

                try {
                    const result = await this.loadData(400, true);
                    return result !== null;
                } finally {
                    this.isLoadingMoreHistory = false;
                }
            }
            
            updateChart(klineData) {
                const labels = [];
                const data = [];
                
                // 转换数据
                klineData.forEach(item => {
                    const date = new Date(item.timestamp);
                    labels.push(date.toLocaleString());
                    data.push(item.close); // 使用收盘价作为价差
                });
                
                // 保存完整数据供拖拽使用
                const dataset = {
                    label: `${this.selectedExchanges[0].toUpperCase()} 价差`,
                    data: data,
                    fullData: data.slice(), // 保存完整数据副本
                    borderColor: this.getExchangeColor(this.selectedExchanges[0]),
                    backgroundColor: this.getExchangeColor(this.selectedExchanges[0]) + '20',
                    fill: false
                };
                
                // 更新图表
                this.chart.data.labels = labels;
                this.chart.data.datasets = [dataset];
                
                // 保存完整标签供拖拽使用
                this.chart.data.fullLabels = labels.slice();
                
                this.chart.update('none');
                
                console.log(`图表更新: ${labels.length} 个数据点`);
            }
            
            updateMultiChart(multiData, options = {}) {
                const { isLoadingMore = false, wasAtRightEdge = true, previousLength = 0, preserveView = false, targetStartIndex = null } = options;

                const allTimestamps = new Set();
                Object.values(multiData).forEach(exchangeData => {
                    exchangeData.forEach(item => {
                        if (item && item.timestamp) {
                            allTimestamps.add(item.timestamp);
                        }
                    });
                });

                const sortedTimestamps = Array.from(allTimestamps).sort((a, b) => a - b);
                const labels = sortedTimestamps.map(timestamp => new Date(timestamp).toLocaleString());

                const datasets = [];

                this.selectedExchanges.forEach(exchange => {
                    const exchangeData = multiData[exchange] || [];
                    if (exchangeData.length === 0) {
                        return;
                    }

                    const dataByTimestamp = new Map(exchangeData.map(item => [item.timestamp, item]));

                    const values = [];
                    const exchangePrices = [];
                    const binancePrices = [];
                    const priceDiffs = [];

                    sortedTimestamps.forEach(timestamp => {
                        const point = dataByTimestamp.get(timestamp);
                        if (point) {
                            const closeValue = point.close !== null && point.close !== undefined
                                ? parseFloat(point.close)
                                : null;
                            values.push(Number.isFinite(closeValue) ? closeValue : null);
                            exchangePrices.push(point.exchangePrice !== undefined ? point.exchangePrice : null);
                            binancePrices.push(point.binancePrice !== undefined ? point.binancePrice : null);
                            priceDiffs.push(point.priceDiff !== undefined ? point.priceDiff : closeValue);
                        } else {
                            values.push(null);
                            exchangePrices.push(null);
                            binancePrices.push(null);
                            priceDiffs.push(null);
                        }
                    });

                    if (!values.some(v => v !== null)) {
                        return;
                    }

                    datasets.push({
                        label: `${exchange.toUpperCase()} 价差`,
                        data: values.slice(),
                        fullData: values,
                        borderColor: this.getExchangeColor(exchange),
                        backgroundColor: this.getExchangeColor(exchange) + '20',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 3,
                        spanGaps: true,
                        exchange,
                        exchangePrices: exchangePrices.slice(),
                        binancePrices: binancePrices.slice(),
                        priceDiffs: priceDiffs.slice(),
                        fullExchangePrices: exchangePrices,
                        fullBinancePrices: binancePrices,
                        fullPriceDiffs: priceDiffs
                    });
                });

                this.chart.data.fullLabels = labels.slice();
                this.chart.data.labels = labels.slice();
                this.chart.data.datasets = datasets;
                this.fullDataLength = labels.length;

                this.postUpdateView({
                    isLoadingMore,
                    wasAtRightEdge,
                    previousLength,
                    preserveView,
                    targetStartIndex
                });

                console.log(`多交易所图表更新: ${this.selectedExchanges.join(', ')} - ${labels.length} 个时间点`);
            }

            postUpdateView({ isLoadingMore, wasAtRightEdge, previousLength, preserveView = false, targetStartIndex = null }) {
                const fullLength = this.chart.data.fullLabels ? this.chart.data.fullLabels.length : 0;

                if (!fullLength) {
                    this.chart.update('none');
                    return;
                }

                if (!this.isViewInitialized) {
                    this.visibleDataCount = Math.min(this.getDefaultVisibleCount(this.currentInterval), fullLength);
                    this.viewStartIndex = Math.max(0, fullLength - this.visibleDataCount);
                    this.isViewInitialized = true;
                } else if (preserveView && targetStartIndex !== null) {
                    // 静默更新模式：保持当前视图位置
                    const maxStart = Math.max(0, fullLength - this.visibleDataCount);
                    this.viewStartIndex = Math.min(Math.max(0, targetStartIndex), maxStart);
                    console.log(`静默更新：保持视图位置在 ${this.viewStartIndex}`);
                } else {
                    const maxStart = Math.max(0, fullLength - this.visibleDataCount);

                    if (isLoadingMore && previousLength) {
                        const addedCount = fullLength - previousLength;
                        if (addedCount > 0) {
                            this.viewStartIndex = Math.min(maxStart, this.viewStartIndex + addedCount);
                        } else {
                            this.viewStartIndex = Math.min(this.viewStartIndex, maxStart);
                        }
                    } else if (wasAtRightEdge) {
                        this.viewStartIndex = maxStart;
                    } else {
                        this.viewStartIndex = Math.min(this.viewStartIndex, maxStart);
                    }
                }

                this.updateVisibleRange(this.viewStartIndex, -1);
                this.previousFullDataLength = fullLength;
            }
            
            updateSidebar(klineData) {
                if (klineData.length === 0) return;
                
                const latest = klineData[klineData.length - 1];
                
                const formatValue = (value) => {
                    if (value === null || value === undefined) return '--';
                    const num = parseFloat(value);
                    if (isNaN(num)) return '--';
                    const sign = num >= 0 ? '+' : '';
                    return sign + num.toFixed(4) + ' USDT';
                };
                
                const getClass = (value) => {
                    const num = parseFloat(value);
                    if (isNaN(num)) return '';
                    return num >= 0 ? 'positive' : 'negative';
                };
                
                // 更新价格信息
                document.getElementById('openPrice').textContent = formatValue(latest.open);
                document.getElementById('openPrice').className = getClass(latest.open);
                
                document.getElementById('highPrice').textContent = formatValue(latest.high);
                document.getElementById('highPrice').className = getClass(latest.high);
                
                document.getElementById('lowPrice').textContent = formatValue(latest.low);
                document.getElementById('lowPrice').className = getClass(latest.low);
                
                document.getElementById('closePrice').textContent = formatValue(latest.close);
                document.getElementById('closePrice').className = getClass(latest.close);
                
                document.getElementById('volume').textContent = latest.volume || '--';
            }
            
            updateMultiSidebar(multiData) {
                // 对于多交易所数据，显示第一个有数据的交易所的最新信息
                let latest = null;
                
                for (const exchange of this.selectedExchanges) {
                    if (multiData[exchange] && multiData[exchange].length > 0) {
                        latest = multiData[exchange][multiData[exchange].length - 1];
                        break;
                    }
                }
                
                if (!latest) {
                    // 如果没有找到数据，清空显示
                    document.getElementById('openPrice').textContent = '--';
                    document.getElementById('highPrice').textContent = '--';
                    document.getElementById('lowPrice').textContent = '--';
                    document.getElementById('closePrice').textContent = '--';
                    document.getElementById('volume').textContent = '--';
                    return;
                }
                
                const formatValue = (value) => {
                    if (value === null || value === undefined) return '--';
                    const num = parseFloat(value);
                    if (isNaN(num)) return '--';
                    const sign = num >= 0 ? '+' : '';
                    return sign + num.toFixed(4) + ' USDT';
                };
                
                const getClass = (value) => {
                    const num = parseFloat(value);
                    if (isNaN(num)) return '';
                    return num >= 0 ? 'positive' : 'negative';
                };
                
                // 更新价格信息
                document.getElementById('openPrice').textContent = formatValue(latest.open);
                document.getElementById('openPrice').className = getClass(latest.open);
                
                document.getElementById('highPrice').textContent = formatValue(latest.high);
                document.getElementById('highPrice').className = getClass(latest.high);
                
                document.getElementById('lowPrice').textContent = formatValue(latest.low);
                document.getElementById('lowPrice').className = getClass(latest.low);
                
                document.getElementById('closePrice').textContent = formatValue(latest.close);
                document.getElementById('closePrice').className = getClass(latest.close);
                
                document.getElementById('volume').textContent = latest.volume || '--';
            }
            
            async loadStatistics() {
                try {
                    const response = await fetch('/api/statistics');
                    const result = await response.json();
                    
                    if (result.success) {
                        const stats = result.data;
                        
                        document.getElementById('totalRecords').textContent = 
                            stats.total_records || '--';
                        document.getElementById('activeExchanges').textContent = 
                            stats.active_exchanges || '--';
                        document.getElementById('latestTime').textContent = 
                            stats.latest_time ? new Date(stats.latest_time).toLocaleString() : '--';
                    }
                } catch (error) {
                    console.error('统计信息加载失败:', error);
                }
            }
            
            getExchangeColor(exchange) {
                const colors = {
                    'aster': '#26a69a',
                    'lighter': '#ef5350', 
                    'edgex': '#ab47bc',
                    'binance': '#ff9800'
                };
                return colors[exchange] || '#ffffff';
            }
            
            showLoading(show) {
                document.getElementById('loading').style.display = show ? 'flex' : 'none';
            }
            
            isViewingHistoricalData() {
                // 检查用户是否在查看历史数据（不在最新数据范围）
                if (!this.chart?.data?.fullLabels || !this.isViewInitialized) {
                    return false;
                }
                
                const fullLength = this.chart.data.fullLabels.length;
                const maxStartForLatest = Math.max(0, fullLength - this.visibleDataCount);
                
                // 如果viewStartIndex明显小于最新数据的起始位置，说明在看历史数据
                return this.viewStartIndex < maxStartForLatest - 5; // 5个数据点的缓冲
            }
            
            async silentUpdate() {
                // 静默更新：保持当前视图位置，只更新数据
                console.log('🔄 静默更新数据...');
                
                try {
                    const exchangesParam = this.selectedExchanges.join(',');
                    const response = await fetch(
                        `/api/kline_data?exchanges=${exchangesParam}&interval=${this.currentInterval}&limit=300`
                    );
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        // 保存当前视图状态
                        const currentStartIndex = this.viewStartIndex;
                        const currentVisibleCount = this.visibleDataCount;
                        
                        // 更新数据但不重置视图
                        this.updateMultiChart(result.data, {
                            isLoadingMore: false,
                            preserveView: true,
                            targetStartIndex: currentStartIndex,
                            targetVisibleCount: currentVisibleCount
                        });
                        
                        console.log(`✅ 静默更新完成，保持视图: ${currentStartIndex}-${currentStartIndex + currentVisibleCount}`);
                    }
                } catch (error) {
                    console.error('静默更新失败:', error);
                }
            }
            
            startAutoRefresh() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
                
                // 每5秒智能刷新
                this.refreshInterval = setInterval(() => {
                    if (this.isViewingHistoricalData()) {
                        // 用户在查看历史数据，使用静默更新
                        this.silentUpdate();
                    } else {
                        // 用户在查看最新数据，正常更新
                        this.loadData();
                    }
                    this.loadStatistics();
                }, 5000);
                
                console.log('🕒 智能自动刷新已启动');
            }
            
            destroy() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
                if (this.chart) {
                    this.chart.destroy();
                }
            }
        }
        
        // 初始化
        let klineManager;
        
        document.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('开始初始化klineManager...');
                klineManager = new SimpleKLineManager();
                window.klineManager = klineManager; // 添加到全局作用域便于调试
                console.log('klineManager初始化成功');
            } catch (e) {
                console.error('klineManager初始化失败:', e);
            }
        });
        
        // 清理
        window.addEventListener('beforeunload', () => {
            if (klineManager) {
                klineManager.destroy();
            }
        });
    </script>
</body>
</html>
